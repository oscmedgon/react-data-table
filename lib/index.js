"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports["default"]=ReactTabularGrid;var _react=require("react");var _react2=_interopRequireDefault(_react);var _lodash=require("lodash.clonedeep");var _lodash2=_interopRequireDefault(_lodash);var _pathutils=require("./services/pathutils");var _dateUtils=require("./services/dateUtils");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj};}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread();}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}function _iterableToArray(iter){if(typeof Symbol!=="undefined"&&Symbol.iterator in Object(iter))return Array.from(iter);}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr);}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj;};}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};}return _typeof(obj);}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest();}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}function _iterableToArrayLimit(arr,i){if(typeof Symbol==="undefined"||!(Symbol.iterator in Object(arr)))return;var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"]!=null)_i["return"]();}finally{if(_d)throw _e;}}return _arr;}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr;}/**
 *
 * @param {array} data
 * @param {object} options
 * @param {object} options.columns
 * @param {string|object} options.columns[]
 * @param {string} options.columns[].path
 * @param {string} options.columns[].label
 * @param {"string"|"date"} options.columns[].type
 * @param {boolean} options.columns[].lock
 * @param {boolean} options.columns[].hide
 * @param {boolean} options.columns[].renderContent
 * @param {boolean} options.applyHiddenFilter
 * @param {object} options.icons
 * @param {object} options.icons.lock
 * @param {string} options.icons.filter
 * @param {string} options.icons.lock.on
 * @param {string} options.icons.lock.off
 * @param {object} options.icons.hide
 * @param {string} options.icons.hide.on
 * @param {string} options.icons.hide.off
 * @return {JSX.Element}
 * @constructor
 */function ReactTabularGrid(_ref){var data=_ref.data,options=_ref.options;var _React$useState=_react2["default"].useState([]),_React$useState2=_slicedToArray(_React$useState,2),columns=_React$useState2[0],setColumns=_React$useState2[1];_react2["default"].useEffect(function(){var newColumns=Object.keys(options.columns).map(function(key){var base={name:key};if(typeof options.columns[key]==='string'){base.path=options.columns[key];base.type='string';base.lock=false;base.hide=false;base.label=base.name;}else if(_typeof(options.columns[key])==='object'){var _options$columns$key=options.columns[key],path=_options$columns$key.path,_options$columns$key$=_options$columns$key.type,type=_options$columns$key$===void 0?'string':_options$columns$key$,_options$columns$key$2=_options$columns$key.lock,lock=_options$columns$key$2===void 0?false:_options$columns$key$2,_options$columns$key$3=_options$columns$key.hide,hide=_options$columns$key$3===void 0?false:_options$columns$key$3,_options$columns$key$4=_options$columns$key.label,label=_options$columns$key$4===void 0?base.name:_options$columns$key$4,renderContent=_options$columns$key.renderContent;base.path=path;base.type=type;base.lock=lock;base.hide=hide;base.label=label;base.renderContent=renderContent;}return base;});setColumns(newColumns);},[JSON.stringify({data:data,options:options})]);return/*#__PURE__*/_react2["default"].createElement(ColumnsComponent,{options:options,columns:columns,data:data});}function ColumnsComponent(_ref2){var _ref2$options=_ref2.options;_ref2$options=_ref2$options===void 0?{}:_ref2$options;var _ref2$options$applyHi=_ref2$options.applyHiddenFilters,applyHiddenFilters=_ref2$options$applyHi===void 0?true:_ref2$options$applyHi,_ref2$options$dateFor=_ref2$options.dateFormat,dateFormat=_ref2$options$dateFor===void 0?'DD/MM/YYYY hh:mm:ss':_ref2$options$dateFor,_ref2$options$icons=_ref2$options.icons;_ref2$options$icons=_ref2$options$icons===void 0?{}:_ref2$options$icons;var _ref2$options$icons$f=_ref2$options$icons.filter,filterIcon=_ref2$options$icons$f===void 0?'fas fa-filter':_ref2$options$icons$f,_ref2$options$icons$l=_ref2$options$icons.lock;_ref2$options$icons$l=_ref2$options$icons$l===void 0?{}:_ref2$options$icons$l;var _ref2$options$icons$l2=_ref2$options$icons$l.on,lockIconOn=_ref2$options$icons$l2===void 0?'fas fa-lock':_ref2$options$icons$l2,_ref2$options$icons$l3=_ref2$options$icons$l.off,lockIconOff=_ref2$options$icons$l3===void 0?'fas fa-lock-open':_ref2$options$icons$l3,_ref2$options$icons$h=_ref2$options$icons.hide;_ref2$options$icons$h=_ref2$options$icons$h===void 0?{}:_ref2$options$icons$h;var _ref2$options$icons$h2=_ref2$options$icons$h.on,hideIconOn=_ref2$options$icons$h2===void 0?'fas fa-eye-slash':_ref2$options$icons$h2,_ref2$options$icons$h3=_ref2$options$icons$h.off,hideIconOff=_ref2$options$icons$h3===void 0?'fas fa-eye':_ref2$options$icons$h3,data=_ref2.data,columns=_ref2.columns;var _React$useState3=_react2["default"].useState(columns),_React$useState4=_slicedToArray(_React$useState3,2),config=_React$useState4[0],setConfig=_React$useState4[1];var _React$useState5=_react2["default"].useState(false),_React$useState6=_slicedToArray(_React$useState5,2),settingsStatus=_React$useState6[0],setSettingsStatus=_React$useState6[1];var _React$useState7=_react2["default"].useState([]),_React$useState8=_slicedToArray(_React$useState7,2),uniqueValues=_React$useState8[0],setUniqueValues=_React$useState8[1];var _React$useState9=_react2["default"].useState(data),_React$useState10=_slicedToArray(_React$useState9,2),filteredData=_React$useState10[0],setFilteredData=_React$useState10[1];var _React$useState11=_react2["default"].useState([]),_React$useState12=_slicedToArray(_React$useState11,2),filters=_React$useState12[0],setFilters=_React$useState12[1];var _React$useState13=_react2["default"].useState(null),_React$useState14=_slicedToArray(_React$useState13,2),showFilterMenu=_React$useState14[0],setShowFilterMenu=_React$useState14[1];_react2["default"].useEffect(function(){var newFilteredData=config.reduce(function(acc,column){if(column.hide&&!applyHiddenFilters){return acc;}var columnFilters=filters.find(function(el){return el.name===column.name;});if(!columnFilters){return acc;}return(0,_pathutils.getFilteredColumn)(column.path,acc,columnFilters.values);},(0,_lodash2["default"])(data));setFilteredData(newFilteredData);},[JSON.stringify({data:data,filters:filters})]);_react2["default"].useEffect(function(){var currentConfig=config.map(function(el){return _objectSpread({},el);});var newConfig=columns;if(currentConfig.length===0){if(newConfig.length){var newUnique=newConfig.map(function(_ref3){var path=_ref3.path,name=_ref3.name;return{name:name,path:path,values:path?(0,_pathutils.getUniqueValuesByPath)(path,data):null};});setUniqueValues(newUnique);}setConfig(newConfig);}else{var populated=currentConfig.reduce(function(acc,el){var prevColIndex=newConfig.findIndex(function(_ref4){var name=_ref4.name;return name===el.name;});if(prevColIndex===-1){return acc;}var name=el.name;var _newConfig$prevColInd=newConfig[prevColIndex],label=_newConfig$prevColInd.label,path=_newConfig$prevColInd.path,hide=_newConfig$prevColInd.hide,lock=_newConfig$prevColInd.lock;var newEl={name:name,hide:el.hide!==undefined?el.hide:hide,label:el.label!==undefined?el.label:label,lock:el.lock!==undefined?el.lock:lock,path:path};acc.push(newEl);return acc;},[]);if(populated.length){var _newUnique=newConfig.map(function(_ref5){var path=_ref5.path,name=_ref5.name;return{name:name,path:path,values:(0,_pathutils.getUniqueValuesByPath)(path,data)};});setUniqueValues(_newUnique);}setConfig(populated);}},[JSON.stringify({columns:columns})]);function onFilterChange(columnName,id,value){var prevFilters=_toConsumableArray(filters);var currentColumnFiltersIndex=prevFilters.findIndex(function(el){return el.name===columnName;});if(currentColumnFiltersIndex!==-1){if(!value){var itemToRemove=prevFilters[currentColumnFiltersIndex].values.findIndex(function(el){return el===id;});prevFilters[currentColumnFiltersIndex].values.splice(itemToRemove,1);}else{prevFilters[currentColumnFiltersIndex].values.push(id);}}else{prevFilters.push({name:columnName,values:[id]});}var newFilters=prevFilters.filter(function(cat){return cat.values.length>=1;});setFilters(newFilters);}function manageToggleFilter(columnName){if(showFilterMenu&&showFilterMenu===columnName){setShowFilterMenu(null);}else{setShowFilterMenu(columnName);}}function manageToggleLock(columnName){var newConfig=config.map(function(el){if(el.name===columnName){return _objectSpread(_objectSpread({},el),{},{lock:!el.lock});}return el;});setConfig(newConfig);}function manageToggleHide(columnName){var newConfig=config.map(function(el){if(el.name===columnName){return _objectSpread(_objectSpread({},el),{},{hide:!el.hide});}return el;});setConfig(newConfig);}function renderColumn(_ref6,columnIndex){var name=_ref6.name,path=_ref6.path,type=_ref6.type,label=_ref6.label,lock=_ref6.lock,hide=_ref6.hide,renderContent=_ref6.renderContent;if(hide||!path&&!renderContent){return null;}var header=label||name;var columnUniqueValues=path?uniqueValues.find(function(col){return col.name===name;}):null;var columnFilters=filters.find(function(col){return col.name===name;});return/*#__PURE__*/_react2["default"].createElement("div",{className:"tabular-column",id:header,key:"".concat(header,"-COLUMN"),"data-index":columnIndex},/*#__PURE__*/_react2["default"].createElement("div",{className:"tabular-header"},/*#__PURE__*/_react2["default"].createElement("div",{className:"tabular-header__wrapper"},/*#__PURE__*/_react2["default"].createElement("div",{className:"header-label"},header),/*#__PURE__*/_react2["default"].createElement("div",{className:"header-actions","data-filters":(columnFilters===null||columnFilters===void 0?void 0:columnFilters.values.length)||0},/*#__PURE__*/_react2["default"].createElement("i",{className:filterIcon,"data-filters":(columnFilters===null||columnFilters===void 0?void 0:columnFilters.values.length)||0,onClick:function onClick(){return manageToggleFilter(name);}}),/*#__PURE__*/_react2["default"].createElement("i",{className:lock?lockIconOn:lockIconOff,onClick:function onClick(){return manageToggleLock(name);}}),/*#__PURE__*/_react2["default"].createElement("i",{className:hide?hideIconOn:hideIconOff,onClick:function onClick(){return manageToggleHide(name);}})),showFilterMenu!==null&&showFilterMenu===name&&/*#__PURE__*/_react2["default"].createElement("div",{className:"header-label__filters-container"},columnUniqueValues===null||columnUniqueValues===void 0?void 0:columnUniqueValues.values.map(function(el){return/*#__PURE__*/_react2["default"].createElement("div",{className:"filter-item"},type==='string'&&/*#__PURE__*/_react2["default"].createElement("label",{htmlFor:el},el),type==='date'&&/*#__PURE__*/_react2["default"].createElement("label",{htmlFor:el},(0,_dateUtils.parseStringDate)(el,dateFormat),"                                        "),/*#__PURE__*/_react2["default"].createElement("input",{type:"checkbox",id:el,defaultChecked:columnFilters===null||columnFilters===void 0?void 0:columnFilters.values.includes(String(el)),onChange:function onChange(_ref7){var target=_ref7.target;return onFilterChange(name,target.id,target.checked);}}));})))),filteredData.map(function(el,index){if(renderContent&&typeof renderContent==='function'){return/*#__PURE__*/_react2["default"].createElement("div",{className:"tabular-cell",key:"".concat(header,"-ROW-").concat(index)},renderContent({rowData:filteredData[index],fullData:filteredData,columnUniqueValues:columnUniqueValues,columnFilters:columnFilters,config:{column:{name:name,path:path,type:type,label:label,lock:lock,hide:hide},global:config}}));}if(!path){var error=new Error('Tryed to render a column without an specified path');console.error(error.stack);return null;}switch(type){case'date':{var formattedDate=(0,_dateUtils.parseStringDate)((0,_pathutils.accessObjectByString)(path,el),dateFormat);return/*#__PURE__*/_react2["default"].createElement("div",{className:"tabular-cell",key:"".concat(header,"-ROW-").concat(index)},formattedDate);}default:{return/*#__PURE__*/_react2["default"].createElement("div",{className:"tabular-cell",key:"".concat(header,"-ROW-").concat(index)},(0,_pathutils.accessObjectByString)(path,el));}}}));}var lockedColumns=config.filter(function(column){return column.lock;});var unlockedColumns=config.filter(function(column){return!column.lock;});return/*#__PURE__*/_react2["default"].createElement("div",{className:"tabular-container"},lockedColumns.length>=1&&/*#__PURE__*/_react2["default"].createElement("div",{className:"locked-columns__container"},lockedColumns.map(renderColumn)),unlockedColumns.map(renderColumn),/*#__PURE__*/_react2["default"].createElement("div",{className:"options-container","data-toggled":settingsStatus},settingsStatus?/*#__PURE__*/_react2["default"].createElement("div",{className:"tabular-settings"},/*#__PURE__*/_react2["default"].createElement("i",{className:"fa fa-times close-settings",onClick:function onClick(){return setSettingsStatus(false);}}),config.map(function(_ref8){var name=_ref8.name,label=_ref8.label,lock=_ref8.lock,hide=_ref8.hide;return/*#__PURE__*/_react2["default"].createElement("div",{className:"tabular-settings__item"},/*#__PURE__*/_react2["default"].createElement("span",{className:"tabular-settings__item-label",title:label},label),/*#__PURE__*/_react2["default"].createElement("div",{className:"tabular-settings__item-actions"},/*#__PURE__*/_react2["default"].createElement("i",{className:lock?lockIconOn:lockIconOff,onClick:function onClick(){return manageToggleLock(name);}}),/*#__PURE__*/_react2["default"].createElement("i",{className:hide?hideIconOn:hideIconOff,onClick:function onClick(){return manageToggleHide(name);}})));})):/*#__PURE__*/_react2["default"].createElement("i",{className:"fa fa-cog open-settings",onClick:function onClick(){return setSettingsStatus(true);}})));}